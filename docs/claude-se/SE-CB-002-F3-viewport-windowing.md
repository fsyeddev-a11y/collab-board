<!-- CLAUDE-SE CHANGE LOG — Auto-generated by Claude-SE after implementing a spec. -->

**Spec Implemented**: CB-002 F3 — Viewport Windowing (Tiered Board State)
**Date**: 2026-02-22

**Summary of Changes**: Extracted the tiered board state logic into a testable utility function `buildTieredBoardState()` in a new file `boardStateBuilder.ts`. The function sends viewport shapes with full detail and off-screen shapes with only a compact summary (id, type, parentId, text). Strips x/y coordinates from all shapes. Uses a 3-pass algorithm: geometric AABB intersection with 10% viewport padding, frame-child promotion, and child-parent promotion. Updated the AI agent system prompt to explain the tiered format. Added 13 comprehensive tests.

**Files Modified**:
- `frontend/src/pages/BoardPage.tsx` — Replaced inline board state serialization in `handleAiGenerate()` with a call to `buildTieredBoardState(editor)`. Added import for the new utility.
- `ai-service/src/agent.ts` — Added BOARD STATE FORMAT section to SYSTEM_PROMPT explaining the tiered format (viewport shapes have `props`, off-screen shapes have `text` only).

**Files Created**:
- `frontend/src/utils/boardStateBuilder.ts` — Extracted, testable utility with `buildTieredBoardState(editor)` function and exported types (`ViewportShape`, `OffScreenShape`, `TieredShape`).
- `frontend/src/tests/viewportWindowing.test.ts` — 13 test cases covering all spec requirements.
- `docs/claude-se/SE-CB-002-F3-viewport-windowing.md` — This change log

**Tests Added/Modified**:
- `frontend/src/tests/viewportWindowing.test.ts` — 13 tests:
  1. All shapes in viewport → all have `props`
  2. Mixed viewport → viewport shapes have `props`, off-screen have `text`
  3. No x/y coordinates on any shape
  4. Frame in viewport promotes children to full detail
  5. Child in viewport promotes parent frame to full detail
  6. Empty text handling (arrows/geo with no text → `text: ""`)
  7. 10% padding inclusion (shape just outside raw viewport but within padding)
  8. Beyond padding exclusion (shape well outside padded viewport)
  9. Empty board → empty array
  10. All shapes off-screen → all compact format
  11. Nested frames (outer frame in viewport → inner frame and children promoted)
  12. Shape exactly on viewport boundary (edge touch → included)
  13. Text extraction per type (note→text, frame→name, geo→text, text→text, arrow→text)

**How to Verify**:
1. Open a board with shapes spread across a wide area (some visible, some off-screen)
2. Open browser DevTools → Network tab
3. Type an AI prompt and submit
4. Inspect the POST /api/generate request body → `boardState` array:
   - Shapes in/near the viewport should have `id, type, parentId, isSelected, props` (no `x`, `y`)
   - Shapes off-screen should have only `id, type, parentId, text` (no `props`, no `x`, `y`)
5. Verify frame grouping: if a frame is partially visible, all its child notes should have full `props`
6. Verify parent promotion: if a child note is visible but its parent frame is off-screen, the parent should have full `props`
7. Verify the AI can still reference and edit off-screen shapes by ID (e.g., "Change the text on [off-screen shape name]")
8. Verify new element creation still works normally (placed in viewport area)
9. Verify no regressions in AI generation quality for visible shapes

**Flagged Issues**: None
